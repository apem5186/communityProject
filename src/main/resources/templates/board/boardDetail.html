<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <div th:insert="~{fragments :: linkCSS}"></div>
    <style>
        a.custom-hover {
            font-weight: bold;
            color: black;
        }
        a.custom-hover:hover {
            color: cornflowerblue;
        }

        .text-container {
            min-height: 100px;
            overflow: auto;
        }

        /* Remove the ability to resize the textarea */
        textarea {
            resize: none;
            overflow-y: hidden; /* Hide vertical scrollbar */
        }

        .replyBtn {
            border: none;
        }
        .replyBtn:hover,
        .replyBtn:active {
            background-color: transparent!important;
            color: dodgerblue!important;
        }

        .likeCnt,
        .likeCnt:disabled {
            font-weight: bold;
            color: black!important;
            border-left: none;
            border-right: none;
        }

        .commentLikeBtn:hover,
        .commentLikeBtn:active {
            background-color: lightblue!important;
        }

        .commentDisLikeBtn:hover,
        .commentDisLikeBtn:active {
            background-color: lightpink!important;
        }

        .commentTrash {
            border: none;
            padding: 0;
        }

        .commentEdit {
            height: 26px;
            border: none;
            border-radius: 25%!important;
            padding: 0;
        }
    </style>
</head>
<body>
<div th:insert="~{fragments :: header}"></div>
<div class="d-flex justify-content-center">
    <div class="w-50">
        <div class="d-flex align-items-center mt-5">
            <div class="flex-grow-1 border-top"></div>
            <span class="px-3 bg-white" th:text="${board.getCategory()}"></span>
            <div class="flex-grow-1 border-top"></div>
        </div>
        <div class="d-flex align-items-center flex-row">
            <a href="#">
                <img class="img-fluid rounded-full" th:src="@{${board.getProfilePath().getPath()}}" alt="프로필 사진"
                style="height: 40px; width: 40px">
            </a>
            <div class="ms-1 d-flex align-items-start flex-column">
                <a class="ps-1 custom-hover text-decoration-none" href="#" th:text="${board.users.getUsername()}"></a>
                <div class="flex items-center text-sm font-normal">
                    <span>
                        <!-- 조회수 -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="width: 16px; height: 16px;" >
                        <!-- 아이콘 경로 -->
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span th:text="${board.getHits()}"></span>
                        <!-- 즐겨찾기 수 -->
                        <i class="bi bi-star"></i>
                        <span th:text="${board.getFavoriteCnt()}"></span>
                    </span>
                </div>
            </div>

            <div th:if="${board.users != null and #authentication.name.equals(board.users.email)}" class="ms-auto">
                <a type="button" class="btn btn-outline-danger" th:href="@{|/${board.getCategory().toLowerCase()}/edit/${board.getBid()}|}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="18" fill="currentColor" class="bi bi-pencil-square" viewBox="0 2 16 16">
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"></path>
                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"></path>
                    </svg>
                </a>
            </div>
        </div>
        <h1 class="fs-2 fw-bold my-4" th:text="${board.getTitle()}"></h1>

        <div th:if="${#lists.size(board.getImgPathList) > 0}" id="carouselIndicators" class="carousel slide carousel-fade">
            <div class="carousel-indicators" aria-hidden="true">
                <button th:each="img, iterStat : ${board.getImgPathList}" type="button" style="filter: invert(1)" data-bs-target="#carouselIndicators" th:data-bs-slide-to="${iterStat.index}" th:class="${iterStat.first} ? 'active' : ''" aria-label="Slide + ${iterStat.count}"></button>
            </div>
            <div class="carousel-inner">
                <div th:each="img, iterStat : ${board.getImgPathList}" th:class="${iterStat.first} ? 'carousel-item active d-flex justify-content-center' : 'carousel-item d-flex justify-content-center'">
                    <div th:if="${#lists.size(board.getImgPathList) > 1}">
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselIndicators" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" style="filter: invert(1)" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                    </div>
                    <img th:src="@{${img}}" class="d-block mx-auto w-75 h-auto" style="width: 500px" alt="Image">
                    <div th:if="${#lists.size(board.getImgPathList) > 1}">
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselIndicators" data-bs-slide="next">
                            <span class="carousel-control-next-icon" style="filter: invert(1)" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
            </div>
<!--            <div th:if="${#lists.size(board.getImgPathList) > 1}">-->
<!--                <button class="carousel-control-prev" type="button" data-bs-target="#carouselIndicators" data-bs-slide="prev">-->
<!--                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>-->
<!--                    <span class="visually-hidden">Previous</span>-->
<!--                </button>-->
<!--                <button class="carousel-control-next" type="button" data-bs-target="#carouselIndicators" data-bs-slide="next">-->
<!--                    <span class="carousel-control-next-icon" aria-hidden="true"></span>-->
<!--                    <span class="visually-hidden">Next</span>-->
<!--                </button>-->
<!--            </div>-->
        </div>

        <div class="text-start fs-4 text-container" th:text="${board.getContent()}"></div>
        <div class="container text-container">
            <div sec:authorize="isAuthenticated()" class="row">
                <!-- 왼쪽 끝에 위치할 요소 -->
                <div class="col-sm-auto fs-5 ps-0">
                    <div class="btn-group">
                        <a type="button" class="btn btn-outline-secondary p-2" style="--bs-btn-hover-bg: ghostwhite;" th:href="@{|/${board.getCategory().toLowerCase()}/favorite/${board.getBid()}|}">
                            <i th:unless="${isFavorite}" class="bi bi-star" style="color: lightgrey"></i>
                            <i th:if="${isFavorite}" class="bi bi-star-fill" style="color: sandybrown"></i>
                        </a>
                    </div>
                </div>

                <!-- 나머지 요소들 (오른쪽으로 정렬) -->
                <div class="col d-flex justify-content-end">
                    <div class="col-sm-auto pe-0">
                        <a href="javascript:void(0);" class="dislike btn btn-outline-dark align-items-center"
                           th:data-uri="@{|/${board.getCategory().toLowerCase()}/dislike/${board.getBid()}|}">
                            <i class="bi bi-chevron-down"></i>
                        </a>
                    </div>
                    <div class="col-sm-auto">
                        <span class="fw-bold d-flex align-items-center justify-content-center px-2 py-1" th:text="${board.getLikeCnt()}"></span>
                    </div>
                    <div class="col-sm-auto ps-0">
                        <a href="javascript:void(0);" class="like btn btn-outline-dark align-items-center" type="button"
                           th:data-uri="@{|/${board.getCategory().toLowerCase()}/like/${board.getBid()}|}">
                            <i class="bi bi-chevron-up"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div sec:authorize="isAnonymous()" class="row">
                <div class="col d-flex justify-content-end">
                    <div class="col-sm-auto pe-0">
                        <a class="btn btn-outline-dark align-items-center" onclick="redirectLogin()">
                            <i class="bi bi-chevron-down"></i>
                        </a>
                    </div>
                    <div class="col-sm-auto">
                        <span class="fw-bold d-flex align-items-center justify-content-center px-2 py-1" th:text="${board.getLikeCnt()}"></span>
                    </div>
                    <div class="col-sm-auto ps-0">
                        <a class="btn btn-outline-dark align-items-center" onclick="redirectLogin()">
                            <i class="bi bi-chevron-up"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="border-top my-3"></div>
        <!-- 댓글 부분 -->
        <div>
            <span class="fs-5" th:text="${comments.getTotalElements() + '개의 댓글'}"></span>
            <div sec:authorize="isAnonymous()" class="my-4 rounded border p-3 my-sm-5 p-sm-4">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle me-3" style="width: 65px; height: 65px;">
                        <img th:src="${profileImage}" alt="Profile Image" class="img-fluid rounded-circle"/>
                    </div>
                    <div class="form-control" contenteditable="false" style="height: 90px;">
                        <a href="/login" style="text-decoration: none;">로그인</a>
                         후 이용가능합니다.
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-2">
                    <button class="btn btn-primary" disabled>댓글 작성</button>
                </div>
            </div>
            <div sec:authorize="isAuthenticated()" class="my-4 rounded border p-3 my-sm-5 p-sm-4">
                <form action="/post/comment" method="post">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle me-3" style="width: 65px; height: 65px;">
                            <img th:src="${profileImage}" alt="Profile Image" class="img-fluid rounded-circle"/>
                        </div>
                        <textarea id="commentTextarea" name="content" class="form-control" rows="3" placeholder="댓글을 작성하세요..." oninput="adjustHeight(this)"></textarea>
                    </div>
                    <input type="hidden" name="bid" th:value="${bid}" />
                    <input type="hidden" name="category" th:value="${board.getCategory().toLowerCase()}">
                    <div class="d-flex justify-content-end align-items-center mt-2">
                        <button type="submit" class="btn btn-primary me-2">댓글 작성</button>
                        <i th:if="${emptyContent}" class="bi bi-exclamation-circle me-2" style="color: tomato;"></i>
                        <p th:if="${emptyContent}" th:text="${emptyContent}" class="mb-0 text-danger">내용을 추가해 주세요.</p>
                    </div>
                </form>

            </div>
                <div class="my-8">
                    <ul class="list-unstyled">
                        <li th:each="comment, commentStat : ${comments}" class="mb-3" th:id="'comment-' + ${comment.cid}">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-3" style="width: 65px; height: 65px;">
                                    <!-- 댓글 작성자 프로필 이미지 -->
                                    <img th:src="${comment.getProfileImgDTOInComment().getPath()}" alt="Profile Image" class="img-fluid rounded-circle">
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex flex-column justify-content-center">
                                            <!-- 댓글 작성자 이름 -->
                                            <strong th:text="${comment.getUsersDTOInComment().getUsername()}">Author Name</strong>
                                            <p class="fw-normal user-select-none mb-0" style="font-size : 0.75rem; font-weight: 200!important;">며칠 전인지 나타내는 부분</p>
                                        </div>
                                        <!-- 로그인 안했을 때 -->
                                        <div sec:authorize="isAnonymous()" class="d-flex">
                                            <div class="btn-group">
                                                <!-- 비추 버튼 -->
                                                <button class="btn btn-sm btn-outline-secondary" style="font-size: 0.75rem;" onclick="redirectLogin()">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                                <!-- 현재 추천 카운트 -->
                                                <button th:text="${comment.likeCnt}" class="likeCnt btn btn-sm btn-outline-secondary disabled" style="font-size: 0.75rem;"></button>
                                                <!-- 추천 버튼 -->
                                                <button class="btn btn-sm btn-outline-secondary" style="font-size: 0.75rem;" onclick="redirectLogin()">
                                                    <i class="bi bi-chevron-up"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- 로그인 했을 때 -->
                                        <div sec:authorize="isAuthenticated()" class="d-flex">
                                            <div class="btn-group">
                                                <!-- 비추 버튼 -->
                                                <form th:action="@{/dislike/comment}" method="post" th:object="${commentLikeDTO}">
                                                    <input type="hidden" name="cid" th:value="${comment.getCid()}"/>
                                                    <input type="hidden" name="bid" th:value="${board.getBid()}"/>
                                                    <input type="hidden" name="page" th:value="${commentStat.index + 1}"/>
                                                    <input type="hidden" name="category" th:value="${board.getCategory()}"/>
                                                    <!-- TODO : 게시글 추천도 이런방식으로 해도 될듯 -->
                                                    <button
                                                            th:class="${comment.likeStatus == 'DISLIKE'} ? 'commentDisLikeBtn btn btn-sm btn-outline-danger' :
                                                        'btn btn-sm btn-outline-secondary'"
                                                            style="font-size: 0.75rem;"
                                                            th:disabled="${comment.likeStatus == 'LIKE'}">
                                                        <i class="bi bi-chevron-down" th:style="${comment.likeStatus == 'DISLIKE'} ? 'color: tomato;' : ''"></i>
                                                    </button>
                                                </form>
                                                <!-- 현재 추천 카운트 -->
                                                <button th:text="${comment.likeCnt}" class="likeCnt btn btn-sm btn-outline-secondary disabled" style="font-size: 0.75rem;"></button>
                                                <!-- Like button -->
                                                <form th:action="@{/like/comment}" method="post" th:object="${commentLikeDTO}">
                                                    <input type="hidden" name="cid" th:value="${comment.getCid()}"/>
                                                    <input type="hidden" name="bid" th:value="${board.getBid()}"/>
                                                    <input type="hidden" name="page" th:value="${commentStat.index + 1}"/>
                                                    <input type="hidden" name="category" th:value="${board.getCategory()}"/>
                                                    <button
                                                            th:class="${comment.likeStatus == 'LIKE'} ? 'commentLikeBtn btn btn-sm btn-outline-primary' :
                                                        'btn btn-sm btn-outline-secondary'"
                                                            style="font-size: 0.75rem;"
                                                            th:disabled="${comment.likeStatus == 'DISLIKE'}">
                                                        <i class="bi bi-chevron-up" th:style="${comment.likeStatus == 'LIKE'} ? 'color: dodgerblue;' : ''"></i>
                                                    </button>
                                                </form>
                                            </div>
                                            <div class="btn-group ms-2" th:if="${comment.getUsersDTOInComment().getEmail()} == ${#authentication.name}">
                                                <button th:id="'editBtn-' + ${comment.cid}" class="commentEdit btn btn-outline-primary px-2" th:onclick="'commentEditToggle(\'' + ${comment.cid} + '\')'">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <form id="commentDelete"
                                                      th:action="@{/delete/comment}" method="post" th:object="${commentLikeDTO}" onclick="commentDeleteConfirm()">
                                                    <input type="hidden" name="cid" th:value="${comment.getCid()}">
                                                    <input type="hidden" name="bid" th:value="${board.getBid()}">
                                                    <input type="hidden" name="page" th:value="${commentStat.index + 1}">
                                                    <input type="hidden" name="category" th:value="${board.getCategory()}"/>
                                                    <button class="commentTrash btn btn-outline-danger px-2">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p th:id="'commentContent-' + ${comment.cid}" class="commentContent" th:text="${comment.content}">Comment content goes here...</p>
                            <!-- 댓글 편집 영역 (초기에는 숨겨져 있음) -->
                            <form th:id="'editForm-' + ${comment.cid}" class="commentEditForm my-2" action="/edit/comment" method="post" style="display:none;">
                                <textarea th:id="'editArea-' + ${comment.cid}" name="content" class="commentEditArea form-control my-2" oninput="adjustHeight(this)"></textarea>
                                <input type="hidden" name="cid" th:value="${comment.getCid()}">
                                <input type="hidden" name="bid" th:value="${board.getBid()}">
                                <input type="hidden" name="page" th:value="${commentStat.index + 1}">
                                <input type="hidden" name="category" th:value="${board.getCategory()}"/>
                                <button class="cancelBtn btn btn-outline-danger" th:onclick="'cancelCommentEdit(event, \'' + ${comment.cid} + '\')'">취소</button>
                                <button type="submit" th:id="'saveBtn-' + ${comment.cid}" class="saveEdit btn btn-outline-success px-2" >수정</button>
                            </form>
                            <button th:id="'replyBtn-' + ${comment.cid}" class="replyBtn btn btn-sm btn-outline-secondary fw-normal my-3" style="font-size: 0.75rem;" th:onclick="'commentEditToggle(' + ${comment.cid} + ')'">댓글 쓰기</button>
                            <!-- Display the divider line for all comments except the last one -->
                            <hr th:unless="${commentStat.index + 1 >= comments.getTotalElements()}" class="m-0"/>
                        </li>
                    </ul>
                </div>
        </div>
    </div>
</div>

<div th:insert="~{fragments :: footer}"></div>
<div th:insert="~{fragments :: linkJS}"></div>
<script layout:fragment="script" type="text/javascript" th:inline="javascript">
    let likeStatus = /*[[${likeStatus}]]*/ 'none';
    const like_elements = document.getElementsByClassName("like");
    const dislike_elements = document.getElementsByClassName("dislike");
    // 추천을 누른 상태면
    if (likeStatus !== 'none' && likeStatus === 'LIKE') {
        for (let i = 0; i < like_elements.length; i++) {
            // 추천 버튼 파랗게 만들고 활성화시킴
            like_elements[i].classList.remove('btn-outline-dark');
            like_elements[i].classList.remove('disabled');
            like_elements[i].classList.add('btn-outline-primary');
        }
        for (let i = 0; i < dislike_elements.length; i++) {
            // 비추 버튼 비활시킴
            dislike_elements[i].classList.add('disabled');
        }
    // 비추 누른 상태면
    } else if (likeStatus !== 'none' && likeStatus === 'DISLIKE') {
        for (let i = 0; i < dislike_elements.length; i++) {
            // 비추 버튼 빨갛게 만들고 활성화 시킴
            dislike_elements[i].classList.remove('disabled');
            dislike_elements[i].classList.remove('btn-outline-dark');
            dislike_elements[i].classList.add('btn-outline-danger');
        }
        for (let i = 0; i < like_elements.length; i++) {
            // 추천 버튼 비활시킴
            like_elements[i].classList.add('disabled');
        }
    }
    Array.from(like_elements).forEach(function (element) {
        element.addEventListener('click', function () {
            location.href = this.dataset.uri;
        })
    })
    Array.from(dislike_elements).forEach(function (element) {
        element.addEventListener('click', function () {
            location.href = this.dataset.uri;
        })
    })

    function redirectLogin() {
        const isConfirmed = confirm("로그인 하셔야 이용 가능합니다. 로그인 하시겠습니까?");

        if (isConfirmed) {
            window.location.href = "/login";
        }
    }

    function commentEditToggle(commentId) {
        console.log(commentId);
        // 댓글 막 시작하는 <li> 부분의 th:id
        const commentElem = document.getElementById('comment-' + commentId);
        // 댓글 편집 전의 <p> 태그, 댓글의 내용 부분
        const contentElem = document.getElementById('commentContent-' + commentId);
        // 편집 기능의 연필 누른 후의 form
        const editFormElem = document.getElementById('editForm-' + commentId);
        // 편집 기능의 연필 누른 후의 textarea, display를 바꿀 필욘 없으나 content 값 받아와야 함
        const editAreaElem = document.getElementById('editArea-' + commentId);
        // 편집 기능 토글 기능을 하는 연필 아이콘
        const editBtn = document.getElementById('editBtn-' + commentId);
        // 대댓 쓰기 버튼
        const replyBtn = document.getElementById('replyBtn-' + commentId);
        // 취소랑 수정 버튼은 editFormElem display = 'block' 하면 생겨남
        editAreaElem.value = contentElem.textContent;

        replyBtn.style.display = 'none';
        contentElem.style.display = 'none';
        editFormElem.style.display = 'block';
        editBtn.style.display = 'none';
    }



    function commentDeleteConfirm() {
        const isConfirmed = confirm("삭제하시면 되돌릴 수 없습니다. 정말 삭제하시겠습니까?");

        if (isConfirmed) {
            const commentDeleteForm = document.getElementById("commentDelete");
            commentDeleteForm.submit();
        }
    }

    function cancelCommentEdit(event, commentId) {
        console.log("cancel : " + commentId);
        event.preventDefault();
        // 댓글 막 시작하는 <li> 부분의 th:id
        const commentElem = document.getElementById('comment-' + commentId);
        // 댓글 편집 전의 <p> 태그, 댓글의 내용 부분
        const contentElem = document.getElementById('commentContent-' + commentId);
        // 편집 기능의 연필 누른 후의 form
        const editFormElem = document.getElementById('editForm-' + commentId);
        // 편집 기능 토글 기능을 하는 연필 아이콘
        const editBtn = document.getElementById('editBtn-' + commentId);
        // 대댓 쓰기 버튼
        const replyBtn = document.getElementById('replyBtn-' + commentId);
        // 취소랑 수정 버튼은 editFormElem display = 'none' 하면 사라짐

        replyBtn.style.display = 'block';
        contentElem.style.display = 'block';
        editFormElem.style.display = 'none';
        editBtn.style.display = 'block';
    }


    function adjustHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }
</script>
</body>
</html>